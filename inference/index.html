
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../training/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>Inference - Wildlife Tools</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.2a3383ac.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#inference-for-ml-models" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Wildlife Tools" class="md-header__button md-logo" aria-label="Wildlife Tools" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Wildlife Tools
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Inference
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/WildlifeDatasets/wildlife-tools" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    wildlife-tools
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Wildlife Tools" class="md-nav__button md-logo" aria-label="Wildlife Tools" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Wildlife Tools
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/WildlifeDatasets/wildlife-tools" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    wildlife-tools
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Inference
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Inference
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#example-of-inference" class="md-nav__link">
    <span class="md-ellipsis">
      Example of inference
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Example of inference">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-dataset" class="md-nav__link">
    <span class="md-ellipsis">
      Create dataset
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extract-features" class="md-nav__link">
    <span class="md-ellipsis">
      Extract features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#calculate-similarity" class="md-nav__link">
    <span class="md-ellipsis">
      Calculate similarity
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluate" class="md-nav__link">
    <span class="md-ellipsis">
      Evaluate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#feature-extractors" class="md-nav__link">
    <span class="md-ellipsis">
      Feature extractors
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Feature extractors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deep-features" class="md-nav__link">
    <span class="md-ellipsis">
      Deep features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#local-features" class="md-nav__link">
    <span class="md-ellipsis">
      Local features
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#similarity-scores" class="md-nav__link">
    <span class="md-ellipsis">
      Similarity scores
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Similarity scores">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#global-similarity-score" class="md-nav__link">
    <span class="md-ellipsis">
      Global similarity score
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matching-based-similarity-scores" class="md-nav__link">
    <span class="md-ellipsis">
      Matching-based similarity scores
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#similarity-scores-calibration" class="md-nav__link">
    <span class="md-ellipsis">
      Similarity scores calibration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../training/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Training ML models
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Pre-trained models
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Pre-trained models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../megadescriptor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MegaDescriptor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../wildfusion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    WildFusion
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    References
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            References
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reference_features/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Features
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reference_inference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Inference
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reference_similarity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Similarity
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reference_training/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Training
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#example-of-inference" class="md-nav__link">
    <span class="md-ellipsis">
      Example of inference
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Example of inference">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-dataset" class="md-nav__link">
    <span class="md-ellipsis">
      Create dataset
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extract-features" class="md-nav__link">
    <span class="md-ellipsis">
      Extract features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#calculate-similarity" class="md-nav__link">
    <span class="md-ellipsis">
      Calculate similarity
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluate" class="md-nav__link">
    <span class="md-ellipsis">
      Evaluate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#feature-extractors" class="md-nav__link">
    <span class="md-ellipsis">
      Feature extractors
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Feature extractors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deep-features" class="md-nav__link">
    <span class="md-ellipsis">
      Deep features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#local-features" class="md-nav__link">
    <span class="md-ellipsis">
      Local features
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#similarity-scores" class="md-nav__link">
    <span class="md-ellipsis">
      Similarity scores
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Similarity scores">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#global-similarity-score" class="md-nav__link">
    <span class="md-ellipsis">
      Global similarity score
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#matching-based-similarity-scores" class="md-nav__link">
    <span class="md-ellipsis">
      Matching-based similarity scores
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#similarity-scores-calibration" class="md-nav__link">
    <span class="md-ellipsis">
      Similarity scores calibration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="inference-for-ml-models">Inference for ML models</h1>
<p>Feature extractors extract feature vectors from images. These features are used for inference, that is predicting the identity in a query image from a database of known individuals.</p>
<h2 id="example-of-inference">Example of inference</h2>
<h3 id="create-dataset">Create dataset</h3>
<p>The simplest way is to use some dataset from the <a href="https://github.com/WildlifeDatasets/wildlife-datasets">WildlifeDataset</a> library. Here, we use the <a href="https://github.com/clwitham/MacaqueFaces/">MacaqueFaces</a> dataset. We specify that we want to apply transform <code>transform</code>. It is also possible to <a href="https://wildlifedatasets.github.io/wildlife-datasets/wildlife_dataset/">load bounding boxes</a> or segmentation masks if provided.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">wildlife_datasets.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">MacaqueFaces</span> 
<span class="kn">import</span><span class="w"> </span><span class="nn">torchvision.transforms</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">T</span>

<span class="n">root</span> <span class="o">=</span> <span class="s2">&quot;data/MacaqueFaces&quot;</span>
<span class="n">transform</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="n">T</span><span class="o">.</span><span class="n">Resize</span><span class="p">([</span><span class="mi">384</span><span class="p">,</span> <span class="mi">384</span><span class="p">]),</span>
    <span class="n">T</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
    <span class="n">T</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">MacaqueFaces</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">MacaqueFaces</span><span class="p">(</span>
    <span class="n">root</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
    <span class="n">load_label</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">factorize_label</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>
<p>Optionally, split the dataset into the database and query sets. The following split is performed so that both sets contains two individuals, each with ten images.</p>
<div class="highlight"><pre><span></span><code><span class="n">idx_train</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">190</span><span class="p">,</span><span class="mi">200</span><span class="p">))</span>
<span class="n">idx_test</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="mi">210</span><span class="p">))</span>
<span class="n">dataset_database</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_subset</span><span class="p">(</span><span class="n">idx_train</span><span class="p">)</span>
<span class="n">dataset_query</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_subset</span><span class="p">(</span><span class="n">idx_test</span><span class="p">)</span>
</code></pre></div>
<h3 id="extract-features">Extract features</h3>
<p>Extract features using the <a href="../megadescriptor/">MegaDescriptor</a> model.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">timm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wildlife_tools.features</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeepFeatures</span>

<span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;hf-hub:BVRA/MegaDescriptor-L-384&quot;</span>
<span class="n">backbone</span> <span class="o">=</span> <span class="n">timm</span><span class="o">.</span><span class="n">create_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">extractor</span> <span class="o">=</span> <span class="n">DeepFeatures</span><span class="p">(</span><span class="n">backbone</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>

<span class="n">query</span><span class="p">,</span> <span class="n">database</span> <span class="o">=</span> <span class="n">extractor</span><span class="p">(</span><span class="n">dataset_query</span><span class="p">),</span> <span class="n">extractor</span><span class="p">(</span><span class="n">dataset_database</span><span class="p">)</span>
</code></pre></div>
<p>Both <code>query</code> and <code>database</code> are of shape 20xn, where n depends on the model and is the size of the feature (embedding) vector.</p>
<h3 id="calculate-similarity">Calculate similarity</h3>
<p>Calculate cosine similarity between query and database deep features.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">wildlife_tools.similarity</span><span class="w"> </span><span class="kn">import</span> <span class="n">CosineSimilarity</span>

<span class="n">similarity_function</span> <span class="o">=</span> <span class="n">CosineSimilarity</span><span class="p">()</span>
<span class="n">similarity</span> <span class="o">=</span> <span class="n">similarity_function</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">database</span><span class="p">)</span>
</code></pre></div>
<p>The <code>similarity</code> is a 20x20 matrix, where each row corresponds to one query image and the entries are the scores of matches between the query image and the images in the database. The highest the score, the more probable it is that the images show the same individual.</p>
<h3 id="evaluate">Evaluate</h3>
<p>Use the cosine similarity in nearest neigbour classifier and get predictions.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wildlife_tools.inference</span><span class="w"> </span><span class="kn">import</span> <span class="n">KnnClassifier</span>

<span class="n">classifier</span> <span class="o">=</span> <span class="n">KnnClassifier</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">database_labels</span><span class="o">=</span><span class="n">dataset_database</span><span class="o">.</span><span class="n">labels_string</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">classifier</span><span class="p">(</span><span class="n">similarity</span><span class="p">)</span>
<span class="n">accuracy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dataset_query</span><span class="o">.</span><span class="n">labels_string</span> <span class="o">==</span> <span class="n">predictions</span><span class="p">)</span>
</code></pre></div>
<h2 id="feature-extractors">Feature extractors</h2>
<p>There are additional ways to extract features from images. Feature extractors, implemented as classes, can be created with specific arguments that define the extraction properties. After instantiation, the extractor functions as a callable, requiring only a single argument — the <code>WildlifeDataset</code> instance. The specific output type and shape vary based on the chosen feature extractor.</p>
<h3 id="deep-features">Deep features</h3>
<p>The features may be extracted by any model, for example by <a href="https://huggingface.co/conservationxlabs/miewid-msv3">MiewID-msv3</a>, which is another model for animal re-identification.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">AutoModel</span>

<span class="n">backbone</span> <span class="o">=</span> <span class="n">AutoModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;conservationxlabs/miewid-msv3&#39;</span><span class="p">,</span> <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">extractor</span> <span class="o">=</span> <span class="n">DeepFeatures</span><span class="p">(</span><span class="n">backbone</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">extractor</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</code></pre></div>
<h3 id="local-features">Local features</h3>
<p>There are multiple local feature extractors including Aliked, DISK, SuperPoint and SIFT.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">wildlife_tools.features</span><span class="w"> </span><span class="kn">import</span> <span class="n">AlikedExtractor</span><span class="p">,</span> <span class="n">DiskExtractor</span><span class="p">,</span> <span class="n">SiftExtractor</span><span class="p">,</span> <span class="n">SuperPointExtractor</span>

<span class="n">device</span> <span class="o">=</span> <span class="s1">&#39;cuda&#39;</span>

<span class="n">extractor</span> <span class="o">=</span> <span class="n">AlikedExtractor</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">extractor</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

<span class="n">extractor</span> <span class="o">=</span> <span class="n">DiskExtractor</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">extractor</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

<span class="n">extractor</span> <span class="o">=</span> <span class="n">SuperPointExtractor</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">extractor</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

<span class="n">extractor</span> <span class="o">=</span> <span class="n">SiftExtractor</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">extractor</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</code></pre></div>
<p>For possible keywords, look at their <a href="https://github.com/WildlifeDatasets/wildlife-tools/blob/main/wildlife_tools/features/local.py">definitions</a>.</p>
<h2 id="similarity-scores">Similarity scores</h2>
<h3 id="global-similarity-score">Global similarity score</h3>
<p>The <code>similarity.cosine</code> module provides tools for calculating global similarity scores between query and database. This is done using cosine similarity between fixed-length embeddings extracted by neural networks.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">wildlife_tools.similarity</span><span class="w"> </span><span class="kn">import</span> <span class="n">CosineSimilarity</span>

<span class="n">similarity</span> <span class="o">=</span> <span class="n">CosineSimilarity</span><span class="p">()</span>
<span class="n">sim</span> <span class="o">=</span> <span class="n">similarity</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">database</span><span class="p">)</span>
</code></pre></div>
<h3 id="matching-based-similarity-scores">Matching-based similarity scores</h3>
<p>The <code>similarity.pairwise</code> module provides tools and methods for calculating pairwise matching similarity scores. At its core, the <code>MatchPairs</code> base class offers pairwise matching with support for batch processing, making it essential for neural network-based matching. Specific implementations of of <code>MatchPairs</code> are:</p>
<ul>
<li><code>MatchLightGlue</code>: It uses the LightGlue model, a lightweight neural matching that uses extracted SIFT, DISK, ALIKED or SuperPoint keypoints and descriptors.</li>
<li><code>MatchLOFTR</code>: It uses the LOFTR (Local Feature TRansformer) model, which performs descriptor-free matching using directly pair of images.</li>
</ul>
<p>Outputs from the matchers, such as confidence scores for local matches and keypoints, are processed using collectors from <code>similarity.pairwise.collectors</code>. In particular, the <code>CollectCounts</code> collector calculates  matching similarity scores by counting significant matches based on given confidence thresholds.</p>
<p>The following example matches all pairs by the SuperGlue matcher with SuperPoint features and calculates similarity scores based on the count of significant matches at confidence thresholds of 0.25, 0.5, and 0.75.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">wildlife_tools.features</span><span class="w"> </span><span class="kn">import</span> <span class="n">SuperPointExtractor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wildlife_tools.similarity</span><span class="w"> </span><span class="kn">import</span> <span class="n">MatchLightGlue</span><span class="p">,</span> <span class="n">CollectCounts</span>

<span class="n">transform</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span><span class="n">T</span><span class="o">.</span><span class="n">Resize</span><span class="p">([</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">]),</span> <span class="n">T</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()])</span>
<span class="n">dataset_query</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">dataset_database</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span><span class="p">,</span> <span class="n">transform</span>
<span class="n">extractor</span> <span class="o">=</span> <span class="n">SuperPointExtractor</span><span class="p">()</span>
<span class="n">matcher</span> <span class="o">=</span> <span class="n">MatchLightGlue</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="s1">&#39;superpoint&#39;</span><span class="p">,</span> <span class="n">collector</span><span class="o">=</span><span class="n">CollectCounts</span><span class="p">(</span><span class="n">thresholds</span><span class="o">=</span><span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">]))</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">matcher</span><span class="p">(</span><span class="n">extractor</span><span class="p">(</span><span class="n">dataset_query</span><span class="p">),</span> <span class="n">extractor</span><span class="p">(</span><span class="n">dataset_database</span><span class="p">))</span>
</code></pre></div>
<p>The following example matches all pairs by the LOFTR matcher and calculates similarity scores based on the count of significant matches at confidence thresholds of 0.25, 0.5, and 0.75. Note that LOFTR operates directly on image pairs and requires no feature extraction.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">wildlife_tools.similarity</span><span class="w"> </span><span class="kn">import</span> <span class="n">MatchLOFTR</span><span class="p">,</span> <span class="n">CollectCounts</span>

<span class="n">transform</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span><span class="n">T</span><span class="o">.</span><span class="n">Resize</span><span class="p">([</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">]),</span> <span class="n">T</span><span class="o">.</span><span class="n">Grayscale</span><span class="p">(),</span> <span class="n">T</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()])</span>
<span class="n">dataset_query</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">dataset_database</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span><span class="p">,</span> <span class="n">transform</span>
<span class="n">matcher</span> <span class="o">=</span> <span class="n">MatchLOFTR</span><span class="p">(</span><span class="n">collector</span><span class="o">=</span><span class="n">CollectCounts</span><span class="p">(</span><span class="n">thresholds</span><span class="o">=</span><span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">]))</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">matcher</span><span class="p">(</span><span class="n">dataset_query</span><span class="p">,</span> <span class="n">dataset_database</span><span class="p">)</span>
</code></pre></div>
<h3 id="similarity-scores-calibration">Similarity scores calibration</h3>
<p>The <code>similarity.calibration</code> module offers tools to improve the interpretability and utility of similarity scores by calibrating them. Calibration allows similarity scores to be interpreted as probabilities, making them suitable for confidence assessments and thresholding. This also enables the effective ensemble of multiple scores by mapping them onto a common probabilistic scale. We implemented calibration methods</p>
<ul>
<li><code>LogisticCalibration</code>: Uses logistic regression to map similarity scores to probabilities, providing a smooth and parametric approach to calibration.</li>
<li><code>IsotonicCalibration</code>: A non-parametric approach that fits isotonic regression. Conceptually similar to score binning.</li>
</ul>
<p>The <code>reliability_diagram</code> function allows for visual comparison of calibrated and uncalibrated scores. This tool is helpful for assessing calibration quality, as it visualizes how well the predicted probabilities align with observed outcomes.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">wildlife_tools.similarity.calibration</span><span class="w"> </span><span class="kn">import</span> <span class="n">IsotonicCalibration</span>

<span class="n">calibration</span> <span class="o">=</span> <span class="n">IsotonicCalibration</span><span class="p">()</span>
<span class="n">calibration</span><span class="o">.</span><span class="n">fit</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">calibration</span><span class="o">.</span><span class="n">predict</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">])</span>
</code></pre></div>
<p>For additional examples on similarity, see the provided <a href="https://github.com/WildlifeDatasets/wildlife-tools/tree/main/examples">Jupyter notebooks</a>.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.sections"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>